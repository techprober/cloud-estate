---
# --- STAGE 1: Bootstrap cloudimg ---
- name: "Bootstrap cloudimg"
  hosts: proxmox_servers
  become: yes

  vars_files:
    - ./group_vars/common.yml
    - ./group_vars/cloudimg.yml

  roles:
    - role: "remote.cloudimg/"
      # vars: # vars available in ./roles/remote.cloudimg/defaults/main/
      #   proxmox_storage: "local-zfs"
      #   cloudinit_default_network_interface: "vmbr2"

# --- STAGE 2: Build VM template ---
- name: "Build VM template"
  hosts: localhost
  connection: local

  vars_files:
    - ./group_vars/packer.yml
    - ./group_vars/build.yml

  # vars:
  #   vm_id: 9001
  #   host_config: "vars/host.pkvars.hcl"
  #   vm_config: "vars/debian-12.pkrvars.hcl"
  #   playbook_file: "playbooks/debian_12_server.yml"
  #   packer_template: "debian-proxmox-packer-template.pkr.hcl"
  #   template_name: "prod-debian-12-server-template"

  roles:
    - role: "local.packer-build/"

# --- STAGE 3: Run post-install tasks ---
- name: "Run post-install tasks"
  hosts: proxmox_servers
  become: yes

  vars_files:
    - ./group_vars/common.yml
    - ./group_vars/build.yml

  roles:
    - role: "remote.post-install.cloudinit/"
