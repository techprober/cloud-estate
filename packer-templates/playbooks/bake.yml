---
# --- STAGE 1: Bootstrap cloudimg ---
- name: "Bootstrap cloudimg"
  hosts: proxmox_servers
  become: yes

  roles:
    - role: "remote.cloudimg/"
      vars: # vars available in ./roles/remote.cloudimg/defaults/main/
        proxmox_storage: "local-zfs"
        cloudinit_default_network_interface: "vmbr2"

# --- STAGE 2: Build VM template ---
- name: "Build VM template"
  hosts: localhost
  connection: local

  vars:
    vm_id: 9001
    host_config: "vars/host.pkvars.hcl"
    vm_config: "vars/debian-12.pkrvars.hcl"
    playbook_file: "playbooks/debian_12_server.yml"
    packer_template: "debian-proxmox-packer-template.pkr.hcl"
    template_name: "prod-debian-12-server-template"

  roles:
    - role: "local.packer-build/"
